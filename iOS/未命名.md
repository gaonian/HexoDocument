





**Table 2**	The sections of a __DATA segment 

- ` __DATA, __data`

  Initialized mutable variables, such as writable C strings and data arrays.

  初始化可变变量，如可写C字符串和数据数组。

- `__DATA,__la_symbol_ptr`

  Lazy symbol pointers, which are indirect references to functions imported from a different file. See “Dynamic Code Generation” in *Mach-O Programming Topics* for more information.

  懒加载符号指针，是对从其他文件导入的函数的间接引用。有关详细信息，请参阅[Mach-O Programming Topics](https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/0-Introduction/introduction.html#//apple_ref/doc/uid/TP40001827-SW1)中的“Dynamic Code Generatio”。

- `__DATA,__nl_symbol_ptr`

  Non-lazy symbol pointers, which are indirect references to data items imported from a different file. See “Dynamic Code Generation” in Mach-O Programming Topics for more information.

  非懒加载符号指针，是对从其他文件导入的函数的间接引用。有关详细信息，请参阅[Mach-O Programming Topics](https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/0-Introduction/introduction.html#//apple_ref/doc/uid/TP40001827-SW1)中的“Dynamic Code Generatio”。

- `__DATA,__dyld`

  Placeholder section used by the dynamic linker.

- `__DATA,__const`

  Initialized relocatable constant variables.

  已初始化可重定位常量变量。

- `__DATA,__mod_init_func`

  Module initialization functions. The C++ compiler places static constructors here.

  模块初始化方法，c++的静态构造函数在这里放

- `__DATA,__mod_term_func`

  Module termination functions.

- `__DATA,__bss`

  Data for uninitialized static variables (for example, static int i;).

  未初始化静态变量的数据（例如，static int i；）

- `__DATA,__common`

  Uninitialized imported symbol definitions (for example, int i;) located in the global scope (outside of a function declaration).

  位于全局范围（函数声明之外）中的未初始化导入符号定义（例如，int i；)



**Table 3**  The sections of a __IMPORT segment 

- `__IMPORT,__jump_table`

  Stubs for calls to functions in a dynamic library.

  动态库中函数调用的存根。

- `__IMPORT,__pointers`

  Non-lazy symbol pointers, which are direct references to functions imported from a different file.

  非懒加载符号指针，它们直接引用从其他文件导入的函数

>  Note: Compilers or any tools that create Mach-O files are free to define additional section names. These additional names do not appear in Table 
>
> 注意：编译器或任何创建mach-o文件的工具都可以自由定义附加的节名。这些附加名称不出现在表中



# Data Types

This reference describes the data types that compose a Mach-O file. Values for integer types in all Mach-O data structures are written using the host CPU’s byte ordering scheme, except for `fat_header` (page 56) and `fat_arch` (page 56), which are written in big-endian byte order.

此参考描述组成mach-o文件的数据类型。所有mach-o数据结构中的整数类型的值都是使用主机cpu的字节顺序方案编写的，除了`fat_header`（第56页）和`fat_arch`（第56页）之外，它们都是以大端字节顺序编写的。

## Header Data Structure

### mach_header

Specifies the general attributes of a file. Appears at the beginning of object files targeted to 32-bit architectures. Declared in /usr/include/mach-o/loader.h. See also mach_header_64 (page 14).

```c
/*
 * The 32-bit mach header appears at the very beginning of the object file for
 * 32-bit architectures.
 */
struct mach_header {
	uint32_t	magic;		/* mach magic number identifier */
	cpu_type_t	cputype;	/* cpu specifier */
	cpu_subtype_t	cpusubtype;	/* machine specifier */
	uint32_t	filetype;	/* type of file */
	uint32_t	ncmds;		/* number of load commands */
	uint32_t	sizeofcmds;	/* the size of all the load commands */
	uint32_t	flags;		/* flags */
};

/* Constant for the magic field of the mach_header (32-bit architectures) */
#define	MH_MAGIC	0xfeedface	/* the mach magic number */
#define MH_CIGAM	0xcefaedfe	/* NXSwapInt(MH_MAGIC) */
```

- **magic**

  An integer containing a value identifying this file as a 32-bit Mach-O file. Use the constant MH_MAGIC if the file is intended for use on a CPU with the same endianness as the computer on which the compiler is running. The constant MH_CIGAM can be used when the byte ordering scheme of the target machine is the reverse of the host CPU.

  一个整数将文件标识为32位Mach-O文件。如果文件要在与运行编译器的计算机具有相同端点的CPU上使用，请使用常量MH_MAGIC。当目标机器的字节排序方案与主机cpu相反时，可以使用常数MH_CIGAM。(大小端值不相同)

- **cputype**

  An integer indicating the architecture you intend to use the file on. Appropriate values include:

  一个整数，指示要在其上使用文件的体系结构。适当的值包括：

  ```c
  #include <mach/machine.h>
  
  /*
   *	Machine types known by all.
   */
   
  #define CPU_TYPE_ANY		((cpu_type_t) -1)
  
  #define CPU_TYPE_VAX		((cpu_type_t) 1)
  /* skip				((cpu_type_t) 2)	*/
  /* skip				((cpu_type_t) 3)	*/
  /* skip				((cpu_type_t) 4)	*/
  /* skip				((cpu_type_t) 5)	*/
  #define	CPU_TYPE_MC680x0	((cpu_type_t) 6)
  #define CPU_TYPE_X86		((cpu_type_t) 7)
  #define CPU_TYPE_I386		CPU_TYPE_X86		/* compatibility */
  #define	CPU_TYPE_X86_64		(CPU_TYPE_X86 | CPU_ARCH_ABI64)
  
  /* skip CPU_TYPE_MIPS		((cpu_type_t) 8)	*/
  /* skip 			((cpu_type_t) 9)	*/
  #define CPU_TYPE_MC98000	((cpu_type_t) 10)
  #define CPU_TYPE_HPPA           ((cpu_type_t) 11)
  #define CPU_TYPE_ARM		((cpu_type_t) 12)
  #define CPU_TYPE_ARM64		(CPU_TYPE_ARM | CPU_ARCH_ABI64)
  #define CPU_TYPE_MC88000	((cpu_type_t) 13)
  #define CPU_TYPE_SPARC		((cpu_type_t) 14)
  #define CPU_TYPE_I860		((cpu_type_t) 15)
  /* skip	CPU_TYPE_ALPHA		((cpu_type_t) 16)	*/
  /* skip				((cpu_type_t) 17)	*/
  #define CPU_TYPE_POWERPC		((cpu_type_t) 18)
  #define CPU_TYPE_POWERPC64		(CPU_TYPE_POWERPC | CPU_ARCH_ABI64)
  ```

- **cpusubtype**

  An integer specifying the exact model of the CPU. To run on all PowerPC or x86 processors supported by the Mac OS X kernel, this should be set to CPU_SUBTYPE_POWERPC_ALL or CPU_SUBTYPE_I386_ALL.

  一个整数，指定CPU的确切型号。要在Mac OS X内核支持的所有PowerPC或x86处理器上运行，应将其设置为CPU_Subtype_PowerPC_All或CPU_Subtype_i386_All。

  ```c
  #define CPU_SUBTYPE_ARM_ALL             ((cpu_subtype_t) 0)
  #define CPU_SUBTYPE_X86_ALL		((cpu_subtype_t)3)
  ```

- **filetype**

  An integer indicating the usage and alignment of the file. Valid values for this field include:

  ```c
  /*
   * A core file is in MH_CORE format and can be any in an arbritray legal
   * Mach-O file.
   *
   * Constants for the filetype field of the mach_header
   */
  #define	MH_OBJECT	0x1		/* relocatable object file */
  #define	MH_EXECUTE	0x2		/* demand paged executable file */
  #define	MH_FVMLIB	0x3		/* fixed VM shared library file */
  #define	MH_CORE		0x4		/* core file */
  #define	MH_PRELOAD	0x5		/* preloaded executable file */
  #define	MH_DYLIB	0x6		/* dynamically bound shared library */
  #define	MH_DYLINKER	0x7		/* dynamic link editor */
  #define	MH_BUNDLE	0x8		/* dynamically bound bundle file */
  #define	MH_DYLIB_STUB	0x9		/* shared library stub for static */
  					/*  linking only, no section contents */
  #define	MH_DSYM		0xa		/* companion file with only debug */
  					/*  sections */
  #define	MH_KEXT_BUNDLE	0xb		/* x86_64 kexts */
  ```

  - The `MH_OBJECT` file type is the format used for intermediate object files. It is a very compact format containing all its sections in one segment. The compiler and assembler usually create one `MH_OBJECT` file for each source code file. By convention, the file name extension for this format is .o.

    `MH_OBJECT`文件类型是用于中间对象文件的格式。它是一种非常紧凑的格式，将其所有部分都包含在一个段中。编译器和汇编程序通常为每个源代码文件创建一个`MH_OBJECT`文件。按照惯例，此格式的文件扩展名为.o。

  - The `MH_EXECUTE` file type is the format used by standard executable programs. 

    `MH_EXECUTE` file type是标准可执行程序使用的格式。

  - The `MH_BUNDLE` file type is the type typically used by code that you load at runtime (typically called bundles or plug-ins). By convention, the file name extension for this format is .bundle.

    `MH_BUNDLE`文件类型是运行时加载的代码通常使用的类型（通常称为bundle或插件）。按照惯例，此格式的文件扩展名为.bundle。 

  - The `MH_DYLIB` file type is for dynamic shared libraries. It contains some additional tables to support multiple modules. By convention, the file name extension for this format is .dylib, except for the main shared library of a framework, which does not usually have a file name extension. 

    `MH_DYLIB`文件类型用于动态共享库。它包含一些额外的表来支持多个模块。按照惯例，此格式的文件扩展名为.dylib，但框架的主共享库除外，它通常没有文件扩展名。

  - The `MH_PRELOAD` file type is an executable format used for special-purpose programs that are not loaded by the Mac OS X kernel, such as programs burned into programmable ROM chips. Do not confuse this file type with the `MH_PREBOUND` flag, which is a flag that the static linker sets in the header structure to mark a prebound image. 

    `MH_PRELOAD`文件类型是一种可执行格式，用于mac os x内核未加载的特殊用途程序，例如烧录到可编程ROM芯片中的程序。不要将此文件类型与`MH_PREBOUND`标志混淆，`MH_PREBOUND`标志是静态链接器在头结构中设置的用于标记预绑定图像的标志。

  - The `MH_CORE` file type is used to store core files, which are traditionally created when a program crashes. Core files store the entire address space of a process at the time it crashed. You can later run gdb on the core file to figure out why the crash occurred. 

    `MH_CORE`文件类型用于存储核心文件，这些文件通常在程序崩溃时创建。核心文件存储进程崩溃时的整个地址空间。您可以稍后在核心文件上运行gdb来找出崩溃的原因。

  - The `MH_DYLINKER` file type is the type of a dynamic linker shared library. This is the type of the dyld file. 

    `MH_DYLINKER`文件类型是动态链接器共享库的类型。这是dyld文件的类型。

  - The `MH_DSYM` file type designates files that store symbol information for a corresponding binary file. 

    `MH_DSYM`文件类型指定存储相应二进制文件的符号信息的文件。

- **ncmds**

  An integer indicating the number of load commands following the header structure.

  指定架构load commands的个数

- **sizeofcmds** 

  An integer indicating the number of bytes occupied by the load commands following the header structure. 所有load commands的size

- **flags**

  An integer containing a set of bit flags that indicate the state of certain optional features of the
  Mach-O file format. These are the masks you can use to manipulate this field:

  一个整数，包含一组位标志，指示mach-o文件格式某些可选功能的状态。以下是可用于操作此字段的掩码：

  ```c
  /* Constants for the flags field of the mach_header */
  #define	MH_NOUNDEFS	0x1		/* the object file has no undefined
  					   references */
  #define	MH_INCRLINK	0x2		/* the object file is the output of an
  					   incremental link against a base file
  					   and can't be link edited again */
  #define MH_DYLDLINK	0x4		/* the object file is input for the
  					   dynamic linker and can't be staticly
  					   link edited again */
  #define MH_BINDATLOAD	0x8		/* the object file's undefined
  					   references are bound by the dynamic
  					   linker when loaded. */
  #define MH_PREBOUND	0x10		/* the file has its dynamic undefined
  					   references prebound. */
  #define MH_SPLIT_SEGS	0x20		/* the file has its read-only and
  					   read-write segments split */
  #define MH_LAZY_INIT	0x40		/* the shared library init routine is
  					   to be run lazily via catching memory
  					   faults to its writeable segments
  					   (obsolete) */
  #define MH_TWOLEVEL	0x80		/* the image is using two-level name
  					   space bindings */
  #define MH_FORCE_FLAT	0x100		/* the executable is forcing all images
  					   to use flat name space bindings */
  #define MH_NOMULTIDEFS	0x200		/* this umbrella guarantees no multiple
  					   defintions of symbols in its
  					   sub-images so the two-level namespace
  					   hints can always be used. */
  #define MH_NOFIXPREBINDING 0x400	/* do not have dyld notify the
  					   prebinding agent about this
  					   executable */
  #define MH_PREBINDABLE  0x800           /* the binary is not prebound but can
  					   have its prebinding redone. only used
                                             when MH_PREBOUND is not set. */
  #define MH_ALLMODSBOUND 0x1000		/* indicates that this binary binds to
                                             all two-level namespace modules of
  					   its dependent libraries. only used
  					   when MH_PREBINDABLE and MH_TWOLEVEL
  					   are both set. */ 
  #define MH_SUBSECTIONS_VIA_SYMBOLS 0x2000/* safe to divide up the sections into
  					    sub-sections via symbols for dead
  					    code stripping */
  #define MH_CANONICAL    0x4000		/* the binary has been canonicalized
  					   via the unprebind operation */
  #define MH_WEAK_DEFINES	0x8000		/* the final linked image contains
  					   external weak symbols */
  #define MH_BINDS_TO_WEAK 0x10000	/* the final linked image uses
  					   weak symbols */
  
  #define MH_ALLOW_STACK_EXECUTION 0x20000/* When this bit is set, all stacks 
  					   in the task will be given stack
  					   execution privilege.  Only used in
  					   MH_EXECUTE filetypes. */
  #define MH_ROOT_SAFE 0x40000           /* When this bit is set, the binary 
  					  declares it is safe for use in
  					  processes with uid zero */
                                           
  #define MH_SETUID_SAFE 0x80000         /* When this bit is set, the binary 
  					  declares it is safe for use in
  					  processes when issetugid() is true */
  
  #define MH_NO_REEXPORTED_DYLIBS 0x100000 /* When this bit is set on a dylib, 
  					  the static linker does not need to
  					  examine dependent dylibs to see
  					  if any are re-exported */
  #define	MH_PIE 0x200000			/* When this bit is set, the OS will
  					   load the main executable at a
  					   random address.  Only used in
  					   MH_EXECUTE filetypes. */
  #define	MH_DEAD_STRIPPABLE_DYLIB 0x400000 /* Only for use on dylibs.  When
  					     linking against a dylib that
  					     has this bit set, the static linker
  					     will automatically not create a
  					     LC_LOAD_DYLIB load command to the
  					     dylib if no symbols are being
  					     referenced from the dylib. */
  #define MH_HAS_TLV_DESCRIPTORS 0x800000 /* Contains a section of type 
  					    S_THREAD_LOCAL_VARIABLES */
  
  #define MH_NO_HEAP_EXECUTION 0x1000000	/* When this bit is set, the OS will
  					   run the main executable with
  					   a non-executable heap even on
  					   platforms (e.g. i386) that don't
  					   require it. Only used in MH_EXECUTE
  					   filetypes. */
  
  #define MH_APP_EXTENSION_SAFE 0x02000000 /* The code was linked for use in an
  					    application extension. */
  
  #define	MH_NLIST_OUTOFSYNC_WITH_DYLDINFO 0x04000000 /* The external symbols
  					   listed in the nlist symbol table do
  					   not include all the symbols listed in
  					   the dyld info. */
  
  #define	MH_SIM_SUPPORT 0x08000000	/* Allow LC_MIN_VERSION_MACOS and
  					   LC_BUILD_VERSION load commands with
  					   the platforms macOS, macCatalyst,
  					   iOSSimulator, tvOSSimulator and
  					   watchOSSimulator. */
  					   
  #define MH_DYLIB_IN_CACHE 0x80000000	/* Only for use on dylibs. When this bit
  					   is set, the dylib is part of the dyld
  					   shared cache, rather than loose in
  					   the filesystem. */
  ```

  - `MH_NOUNDEFS`—The object file contained no undefined references when it was built. 

